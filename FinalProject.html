<!DOCTYPE html>
<html>

<head>
    <style>
        #scatterplot {
            display: none;
        }
        .tooltip {
            position: absolute;
            background: #f9f9f9;
            color: #333;
            border-radius: 5px;
            padding: 10px;
            pointer-events: none;
            border: 1px solid #d4d4d4;
            display: none;
            width: 300px;
        }
    </style>
    <meta charset="utf-8">
    <title></title>
</head>

<body>
    <div id="area"></div>
    <div id="scatterplot">
        <button id="back">Back</button>
        <div id="chart"></div>
    </div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>

        // Create a tooltip div
        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .attr("id", "tooltip");

        d3.csv("Highest Holywood Grossing Movies.csv").then(function (data) { 

            var splitMovies = [];

            data.forEach(function (movie) {
                // Assuming genre is a string that looks like an array.
                var genres = JSON.parse(movie.Genre.replace(/'/g, '"'));
                genres.forEach(function (genre) {
                    var newMovie = { ...movie };  // Create a copy of the movie object
                    newMovie.Genre = genre;  // Replace the genre attribute
                    splitMovies.push(newMovie);
                });
            });

            var dataForStackArea = splitMovies.filter(d => d['Release Date'] !== 'NA')

            document.getElementById("back").addEventListener("click", function() {
            document.getElementById("area").style.display = "block"; // show the area div
            document.getElementById("scatterplot").style.display = "none"; // hide the scatterplot div
        });

        
        
            createStackChart(dataForStackArea)


        })
        .catch(function(error) {
          console.log(error);
        });

        function createStackChart(splitMovies) {
            // Parse date
            var parseTime = d3.timeParse("%B %d, %Y");

            splitMovies.forEach(function (d) {
                var date = parseTime(d["Release Date"]);
                d["Release Date"] = date.getFullYear();
                d["International Sales (in $)"] = +d["International Sales (in $)"];
            });

            // Sort the data by date
            splitMovies.sort((a, b) => a["Release Date"] - b["Release Date"]);

            // First, group the data by release date
            var dataByDate = d3.group(splitMovies, d => d["Release Date"]);

            // Define all possible genres
            var allGenres = Array.from(new Set(splitMovies.map(d => d.Genre)));

            // Then, for each date, sum the sales by genre
            var stackedData = Array.from(dataByDate, ([date, movies]) => {
                var totalSalesByGenre = d3.rollup(movies, v => d3.sum(v, d => d["International Sales (in $)"]), d => d.Genre);
                var dateEntry = { date: date };
                allGenres.forEach(genre => {
                    dateEntry[genre] = totalSalesByGenre.get(genre) || 0;
                });
                return dateEntry;
            });


            var stack = d3.stack()
                .keys(Array.from(new Set(splitMovies.map(d => d.Genre))))
                .order(d3.stackOrderNone)
                .offset(d3.stackOffsetNone);

            var series = stack(stackedData);  

            var svg = d3.select("#area").append("svg")
                .attr("width", 1500)
                .attr("height", 800);

            var margin = { top: 50, right: 20, bottom: 30, left: 70 };
            var width = +svg.attr("width") - margin.left - margin.right;
            var height = +svg.attr("height") - margin.top - margin.bottom;
            var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scaleLinear().rangeRound([0, width]);
            var y = d3.scaleLinear().rangeRound([height, 0]);
            var z = d3.scaleOrdinal(d3.schemeCategory10);

            x.domain(d3.extent(stackedData, function (d) { return d.date; }));
            y.domain([0, d3.max(series, s => d3.max(s, d => d[1]))]).nice();

            var area = d3.area()
                .x(d => x(d.data.date))
                .y0(d => y(d[0]))
                .y1(d => y(d[1]));

            // create a tooltip
            var Tooltip = g
                .append("text")
                .attr("x", 10)
                .attr("y", 10)
                .style("opacity", 0)
                .style("font-size", 17)

            g.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).tickFormat(d3.format("d")))
                .append("text")
                .attr("fill", "#000")
                .attr("y", 30)
                .style('font-size' , '12px')
                .attr("x", width/2)
                .attr("text-anchor", "middle")
                .text("Release Date");


            g.append("g")
                .attr("class", "axis axis--y")
                .call(d3.axisLeft(y).ticks(10, "s"))
                .append("text")
                .attr("fill", "#000")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left/2 - 20)
                .attr("x", -height/2)
                .style('font-size' , '12px')
                .attr("dy", "0.71em")
                .attr("text-anchor", "middle")
                .text("International Sales (in $)");
 
            g.append("text")
                .attr("x", width / 2)
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "20px")
                .style("text-decoration", "underline")
                .text("Movies Sales Over the Years per Genre");

            var layer = g.selectAll(".layer")
                .data(series)
                .join("g")
                .attr("class", "layer");

            layer.append("path")
                .attr("class", "area")
                .attr("d", area)
                .style("fill", d => z(d.key))
                .on("mouseover", function (event, d) {
                    Tooltip.style("opacity", 1)
                    d3.selectAll(".area").style("opacity", .2)
                    d3.select(this)
                        // .style("stroke", "black")
                        .style("opacity", 1)
                })
                .on("mousemove", function (event, d, i) { 
                    grp = d.key
                    Tooltip.text('Genre: ' + grp)
                })
                .on("mouseleave", function (event, d) {
                    Tooltip.style("opacity", 0)
                    d3.selectAll(".area").style("opacity", 1).style("stroke", "none")
                })
                .on('click', (event, d) => {
                    var gerneData = splitMovies.filter(a => a.Genre == d.key)
                    createScatterPlot(gerneData, z(d.key) , d.key)
                    document.getElementById("area").style.display = "none"; // hide the area div
                    document.getElementById("scatterplot").style.display = "block"; // show the scatterplot div

                })


        }

        function createScatterPlot(data, color , selectedGenre) {

            d3.select('#chart svg').remove();

            var svg = d3.select("#chart").append("svg")
                .attr("width", 1000)
                .attr("height", 600);

            var margin = { top:50, right: 20, bottom: 50, left: 70 };
            var width = +svg.attr("width") - margin.left - margin.right;
            var height = +svg.attr("height") - margin.top - margin.bottom;
            var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scaleLinear().rangeRound([0, width]).nice();
            var y = d3.scaleLinear().rangeRound([height, 0]).nice();

            x.domain(d3.extent(data, function (d) { return d["Release Date"]; }));
            y.domain([0, d3.max(data, function (d) { return d["International Sales (in $)"]; })]);

            g.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).tickFormat(d3.format("d")))
                .append("text")
                .attr("fill", "#000")
                .attr("y", 30)
                .style('font-size' , '12px')
                .attr("x", width/2)
                .attr("text-anchor", "middle")
                .text("Release Date");

            g.append("g")
                .call(d3.axisLeft(y).ticks(10, "s"))
                .append("text")
                .attr("fill", "#000")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left/2 - 20)
                .attr("x", -height/2)
                .style('font-size' , '12px')
                .attr("dy", "0.71em")
                .attr("text-anchor", "middle")
                .text("International Sales (in $)");

            g.append("text")
                .attr("x", width / 2)
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "20px")
                .style("text-decoration", "underline")
                .text("Movies Sales Over the Years for " + selectedGenre);

            g.selectAll(".dot")
                .data(data)
                .join("circle")
                .attr("class", "dot")
                .attr("cx", function (d) { return x(d["Release Date"]); })
                .attr("cy", function (d) { return y(d["International Sales (in $)"]); })
                .attr("r", 2)
                .attr('fill-opacity' , 0.2)
                .attr('stroke' , color)
                .attr('fill', color)
                .on("mouseover", function(event, d) {
                    d3.select(this).attr('r' , 4).attr('fill' , 'black').attr('stroke' , 'bkack')

                tooltip.style("display", "inline");
                tooltip.html("<b>Title: </b>" + d.Title +
                 "<br/><b>Sales: </b>" + d["International Sales (in $)"] +'$'+
                 "<br/><b>Info: </b>" + d["Movie Info"] );
            })
            .on("mousemove", function(event, d) {
                tooltip.style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", function(event, d) {
                d3.select(this).attr('r' , 2).attr('fill' , color).attr('stroke' , color)
                tooltip.style("display", "none");
            });


        }
    </script>
</body>

</html>
